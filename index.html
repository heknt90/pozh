<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Билеты ПК</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    body {
      background-image: url("background.jpg");
      background-repeat: no-repeat;
      background-size: cover;
      background-position: -120px center;
      background-attachment: fixed;
      background-blend-mode: darken;
    }

    @media screen and (min-width:500px) {
      body {
        background-image: url("background-1000.jpg");
        background-position: center center;
      }
    }

    @media screen and (min-width:1000px) {
      body {
        background-image: url("background-2000.jpg");
      }
    }
  </style>
</head>

<body class="min-vh-100">
  <div class="container my-3 h-100">
    <div class="row d-flex ">
      <div class="col-12 col-lg-6 offset-lg-6  bg-white rounded ">
        <div class="row ">
          <div class="col-12 pt-5 my-3 d-flex justify-content-center">
            <!-- Start screen -->
            <div class="d-grid gap-2" id="screenStart">
              <button class="btn btn-primary" data-job="driver">Водитель</button>
              <button class="btn btn-primary" data-job="commander">Командир отделения</button>
              <button class="btn btn-primary" data-job="fireman">Пожарный</button>
            </div>
          </div>
          <div class="col-12">
            <div class="my-3 d-flex justify-content-center visually-hidden" id="screenGdzs">
              <div class="btn-group text-white">
                <button class="btn btn-info" data-gdzs="false" id="gdzsWithout">Без ГДЗС</button>
                <button class="btn btn-warning" data-gdzs="true" id="gdzsWith">Есть вопросы про ГДЗС</button>
              </div>
            </div>

            <!-- No ticket -->
            <div>
              <h2 class="text-center" id="header"></h2>
            </div>
            <div class="d-flex justify-content-center flex-wrap my-3" id="screenTicketChoice">

            </div>
            <div>
              <h3 class="text-center" id="subheader"></h3>
              <p class="text-center" id="shortAnswers"></p>
            </div>
            <!-- Ticket -->
            <div class="my-3" id="screenTicketDetails">
              <p class="text-center mt-5">Выберите должность</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="data.js"></script>
  <!-- <script src="main.js"></script> -->
  <script>
    (function () {
      const state = {
        jobTitle: undefined,
        ticketNumber: undefined,
        withGDZS: false
      }

      window.getState = () => state
      window.setState = setState

      function setState(newState) {
        for (let item in newState) {
          state[item] = newState[item]
        }
      }

      const headers = {
        driver: "Билеты для водителей",
        commander: "Билеты для командиров",
        fireman: "Билеты для пожарных",
        withGDZS: " с вопросами по ГДЗС",
        withoutGDZS: " без вопросов по ГДЗС",
      }

      const emptyTicketTitle = "Выберите номер билета."
      // const emptyTicketTitle = "Выберите номер билета выше."

      // Global variable (refactoring requre)
      let ticketsData

      for (let button of document.querySelectorAll('[data-job]')) {
        button.addEventListener('click', jobChoiseButtonHandler)
      }
      for (let button of document.querySelectorAll('[data-gdzs]')) {
        button.addEventListener("click", gdzsChoiseButtonHandler)
      }
      document.querySelector("#screenTicketChoice").addEventListener("click", ticketChoiseButtonHandler)

      function jobChoiseButtonHandler(event) {
        const dataJob = event.target.dataset.job
        if (state["jobTitle"] != dataJob) {
          setState({ jobTitle: dataJob })
          let key = state["jobTitle"] + "sData"
          if (dataJob !== "driver") {
            setState({ withGDZS: true })
            screenGdzs.classList.remove("visually-hidden")
            key += "WithGDZS"
            gdzsWith.focus()
          } else if (!screenGdzs.classList.contains("screenGdzs.classList")) {
            screenGdzs.classList.add("visually-hidden")
            setState({ withGDZS: false })
          }
          ticketsData = data[key]
          updateTicketsList(ticketsData)
          updateTicketsDetails()
        }
      }

      function gdzsChoiseButtonHandler(event) {
        const withGDZS = event.target.dataset.gdzs === "true"
        if (withGDZS !== state["withGDZS"]) {
          setState({ withGDZS })
          const gdzsSuffix = withGDZS ? "WithGDZS" : ""
          const key = state["jobTitle"] + "sData" + gdzsSuffix
          ticketsData = data[key]
          updateTicketsList(ticketsData)
          updateTicketsDetails()
        }
      }

      function ticketChoiseButtonHandler(event) {
        if (event.target.dataset.ticket) {
          const ticketNumber = event.target.dataset.ticket
          let ticketDetails = ticketsData[ticketNumber]
          updateSubheader(ticketNumber)
          updateTicketsDetails(ticketDetails)
        }
      }

      function updateTicketsList(dataJob) {
        updateHeader()
        screenTicketChoice.innerHTML = generateTicketsList()
        console.log(dataJob)
        function generateTicketsList() {
          let content = ""
          for (let item in dataJob) {
            content += templateTicketButton(item)
          }
          return content
        }

        function templateTicketButton(item) {
          return `<button class="btn btn-secondary m-1" data-ticket="${item}">Билет ${item}</button>`
        }
      }

      function updateTicketsDetails(dataTicket) {
        let content
        if (!dataTicket) {
          updateSubheader()
          updateShortAnswers()
          content = templateEmptyTicketTitle()
        } else {
          updateShortAnswers(dataTicket)
          content = generateTicketDetails(dataTicket)
        }
        screenTicketDetails.innerHTML = content

        function generateTicketDetails(dataTicket) {
          let content = "<dl>"
          for (let i = 1; i <= Object.keys(dataTicket).length; i++) {
            content += templateQuestionAndAnswer(i, dataTicket)
          }
          content += "</dl>"
          return content
        }

        function templateQuestionAndAnswer(index, dataTicket) {
          let result = `<dt>${index}. ${dataTicket[index].q}</dt><dd>${dataTicket[index].a}</dd>`
          if (index < Object.keys(dataTicket).length) {
            result += "<hr />"
          }
          return result
        }

        function templateEmptyTicketTitle() {
          return `<p class="text-center mt-5">${emptyTicketTitle}</p>`
        }
      }

      function updateHeader() {
        header.innerText = generateHeaderContent()

        function generateHeaderContent() {
          let content = headers[state["jobTitle"]]
          if (state["withGDZS"]) {
            content += headers["withGDZS"]
          } else if (state["jobTitle"] !== "driver") {
            content += headers["withoutGDZS"]
          }
          return content
        }
      }

      function updateSubheader(ticketNumber) {
        subheader.innerText = generateSubheaderContent(ticketNumber)

        function generateSubheaderContent(ticketNumber) {
          return ticketNumber ? templateSubheader(ticketNumber) : ""
        }

        function templateSubheader(ticketNumber) {
          return "Билет №" + ticketNumber
        }
      }

      function updateShortAnswers(dataTicket) {
        shortAnswers.innerHTML = generateShortAnswersContent(dataTicket)

        function generateShortAnswersContent(dataTicket) {
          let content = ""
          if (dataTicket) {
            for (let item in dataTicket) {
              const answer = dataTicket[item]["a"].split(".")[0]
              content += templateShortAnswer(item, answer)
            }
          }
          return content
        }

        function templateShortAnswer(item, answer) {
          return `<b>${item}:</b> ${answer}; `
        }
      }
    }())
  </script>
</body>

</html>